services:
  # Go Application Server
  app-server:
    build:
      context: ./server
    container_name: serenada-server
    environment:
      - PORT=8080
      - STUN_HOST=${STUN_HOST}
      - TURN_SECRET=${TURN_SECRET}
      - ROOM_ID_SECRET=${ROOM_ID_SECRET}
      - ROOM_ID_ENV=${ROOM_ID_ENV}
      - TURN_HOST=${TURN_HOST}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - TRUST_PROXY=${TRUST_PROXY}
      - BLOCK_WEBSOCKET=${BLOCK_WEBSOCKET}
      - DATA_DIR=/app/data
    volumes:
      - ./server/data:/app/data
    restart: unless-stopped

  # Coturn Server
  coturn:
    image: coturn/coturn:latest
    container_name: serenada-coturn
    restart: unless-stopped
    volumes:
      - ./coturn/turnserver.dev.conf:/etc/coturn/turnserver.conf
    command:
      - /usr/bin/turnserver
      - -c
      - /etc/coturn/turnserver.conf
      - --static-auth-secret=${TURN_SECRET}
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "49152-49200:49152-49200/udp"

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: serenada-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf
      - ./client/dist:/var/www/serenada/dist
    depends_on:
      - app-server
